<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>탱크 재고 현황</title>
<style>
  body{font-family:Arial;margin:0;background:#f4f4f4}
  .controls{padding:14px;background:#fff;border-bottom:1px solid #ddd}
  textarea{width:100%;height:170px}
  button{padding:8px 14px;margin-right:8px;margin-top:6px}
  input[type="date"]{padding:6px 10px;margin-top:6px}
  .wrap{padding:10px}
  svg{background:#fff;border:2px solid #111; display:block; margin:0 auto; max-width:100%; height:auto;}

  .tank circle{stroke-width:3; fill:#fff;}
  .zero circle{fill:#fff7b3;}        /* 0일때 연노랑 */
  .over85 circle{fill:#ffd0d0;}      /* 85%이상 연빨강 */

  /* (1) 원형탱크 글씨도 같이 키움 */
  .tank .name{font-size:18px;text-anchor:middle;dominant-baseline:middle;font-weight:800}
  .tank .qty{font-size:18px;text-anchor:middle;dominant-baseline:middle;font-weight:800; fill:#111}
  .tank .pct{font-size:14px;text-anchor:middle;dominant-baseline:middle;font-weight:700; fill:#111}

  .brtank rect{fill:#fff;stroke:#111;stroke-width:3}
  .brtank .nm{font-size:16px;text-anchor:middle;dominant-baseline:middle;font-weight:800}
  .brtank .qt{font-size:14px;text-anchor:middle;dominant-baseline:middle;font-weight:800}

  .brzero rect{fill:#fff7b3;}
  .brover85 rect{fill:#ffd0d0;}

  .zone{fill:none;stroke:#111;stroke-width:3}
  .zoneTitle{font-size:34px;font-weight:500;fill:#111}
  .zoneNoteRed{font-size:22px;font-weight:900;fill:#d10000}
  .zoneNoteBlue{font-size:22px;font-weight:900;fill:#0066cc}
  .zoneNotePurple{font-size:20px;font-weight:900;fill:#7a2bd1}
  .zoneNoteGreen{font-size:20px;font-weight:900;fill:#00a651}
</style>
</head>
<body>

<div class="controls">
  <div style="font-size:13px;color:#666;line-height:1.45">
    - 엑셀 표 복사 → 아래에 붙여넣기<br>
    - Raw 형식: <b>TANK NO.</b>(0열) / <b>측정량</b>(2열) / <b>제품명</b>(4열)<br>
    - 탱크번호 공백 자동 제거: 예) <b>L&nbsp;&nbsp;9</b> → <b>L9</b>, <b>B&nbsp;1</b> → <b>B1</b><br>
    - 도면에 없는 탱크는 자동 무시
  </div>
  <textarea id="rawData" placeholder="여기에 붙여넣기 (탭 구분)"></textarea><br>
  <button onclick="saveData()">저장(오늘)</button>
  <input type="date" id="datePicker">
  <button onclick="loadByDate()">날짜조회</button>
</div>

<div class="wrap">
  <svg id="canvas" width="1920" height="1080" viewBox="0 0 1920 1080" preserveAspectRatio="xMinYMin meet"></svg>
</div>

<script>
const svg = document.getElementById("canvas");

/* =========================================================
   미세조정 파라미터
========================================================= */
const PACK_TANK_DY = 30;

/* =========================================================
   건물(검정선) 레이아웃
   (4) Milling Area (New) 가로 30px 추가 축소
========================================================= */
const Z = {
  outer: {x:20, y:20, w:1880, h:1040},

  pack:  {x:40, y:40, w:600, h:520},
  office:{x:40, y:560, w:90, h:500},

  // 기존 530에서 30 더 줄임 => 500
  newMill:{x:640, y:40, w:590, h:520},

  pillar:{x:1160, y:40, w:150, h:520},
  oldMill:{x:1310, y:40, w:590, h:520},

  branArea:{x:1720, y:40, w:180, h:520},
};

/* (1) 원형탱크 크기: 반지름 +5px */
const R = 33;
const GX = 72;
const GY = 72;

/* Br 사각탱크 간격 */
const BR_STEP = 5;

/* =========================================================
   포장동 탱크 시작점 (탱크만 +30px 아래)
========================================================= */
const PACK_START = {x: Z.pack.x + 40, y: Z.pack.y + 120 + PACK_TANK_DY};

/* =========================================================
   (2) L1~L6: 왼쪽 -50px, 아래 +60px
========================================================= */
const L16_START = {x: (Z.newMill.x + 60) - 50, y: (Z.newMill.y + 420) + 60};

/* =========================================================
   (5) B1~B4: 왼쪽 -20px, 아래 +60px
========================================================= */
const B_GX = 64;
const B_GY = 64;
const GAP_LEFT = Z.newMill.x + Z.newMill.w;
const GAP_RIGHT = Z.oldMill.x;
const GAP_MID = (GAP_LEFT + GAP_RIGHT) / 2;
const B_START = {x: (GAP_MID - B_GX/2) - 20, y: (Z.newMill.y + 410) + 60};

/* =========================================================
   Br 정렬 (구관 core / branArea)
========================================================= */
const OLD_CORE = {x: Z.oldMill.x, y: Z.oldMill.y, w: (Z.branArea.x - Z.oldMill.x), h: Z.oldMill.h};
const BR_LINE_Y = Z.oldMill.y + 420;
const BR_COL_Y  = Z.oldMill.y + 420;

function calcBrRowBoxWidth(){
  const totalGaps = BR_STEP * 7;
  const w = (OLD_CORE.w - totalGaps) / 8;
  return Math.max(28, Math.floor(w));
}

/* (6) Br5~12 가로폭 20px 줄임 */
let BR_BOX_W = Math.max(20, calcBrRowBoxWidth() - 20);
const BR_BOX_H = 54;

/* Br12~Br5 전체를 OLD_CORE 안에서 가운데 정렬(잘림 방지) */
function brRowStartX(){
  const total = 8*BR_BOX_W + 7*BR_STEP;
  return OLD_CORE.x + Math.max(0, (OLD_CORE.w - total)/2);
}

const BULK_BASE = {x: 820, y: 720};

const tankLayout = {
  /* Packaging Bin (빨강) */
  "A6":{x:PACK_START.x+0*GX,y:PACK_START.y+0*GY,cap:80},
  "A5":{x:PACK_START.x+1*GX,y:PACK_START.y+0*GY,cap:80},
  "3P8":{x:PACK_START.x+2*GX,y:PACK_START.y+0*GY,cap:45},
  "3P7":{x:PACK_START.x+3*GX,y:PACK_START.y+0*GY,cap:45},
  "2P8":{x:PACK_START.x+4*GX,y:PACK_START.y+0*GY,cap:45},
  "2P7":{x:PACK_START.x+5*GX,y:PACK_START.y+0*GY,cap:45},
  "1P8":{x:PACK_START.x+6*GX,y:PACK_START.y+0*GY,cap:45},
  "1P7":{x:PACK_START.x+7*GX,y:PACK_START.y+0*GY,cap:45},

  "A4":{x:PACK_START.x+0*GX,y:PACK_START.y+1*GY,cap:80},
  "A3":{x:PACK_START.x+1*GX,y:PACK_START.y+1*GY,cap:80},
  "3P6":{x:PACK_START.x+2*GX,y:PACK_START.y+1*GY,cap:45},
  "3P5":{x:PACK_START.x+3*GX,y:PACK_START.y+1*GY,cap:45},
  "2P6":{x:PACK_START.x+4*GX,y:PACK_START.y+1*GY,cap:45},
  "2P5":{x:PACK_START.x+5*GX,y:PACK_START.y+1*GY,cap:45},
  "1P6":{x:PACK_START.x+6*GX,y:PACK_START.y+1*GY,cap:45},
  "1P5":{x:PACK_START.x+7*GX,y:PACK_START.y+1*GY,cap:45},

  "A2":{x:PACK_START.x+0*GX,y:PACK_START.y+2*GY,cap:80},
  "A1":{x:PACK_START.x+1*GX,y:PACK_START.y+2*GY,cap:80},
  "3P4":{x:PACK_START.x+2*GX,y:PACK_START.y+2*GY,cap:45},
  "3P3":{x:PACK_START.x+3*GX,y:PACK_START.y+2*GY,cap:45},
  "2P4":{x:PACK_START.x+4*GX,y:PACK_START.y+2*GY,cap:45},
  "2P3":{x:PACK_START.x+5*GX,y:PACK_START.y+2*GY,cap:45},
  "1P4":{x:PACK_START.x+6*GX,y:PACK_START.y+2*GY,cap:45},
  "1P3":{x:PACK_START.x+7*GX,y:PACK_START.y+2*GY,cap:45},

  "3P2":{x:PACK_START.x+2*GX,y:PACK_START.y+3*GY,cap:45},
  "3P1":{x:PACK_START.x+3*GX,y:PACK_START.y+3*GY,cap:45},
  "2P2":{x:PACK_START.x+4*GX,y:PACK_START.y+3*GY,cap:45},
  "2P1":{x:PACK_START.x+5*GX,y:PACK_START.y+3*GY,cap:45},
  "1P2":{x:PACK_START.x+6*GX,y:PACK_START.y+3*GY,cap:45},
  "1P1":{x:PACK_START.x+7*GX,y:PACK_START.y+3*GY,cap:45},

  /* T 라인 (파랑) */
  "T6":{x:PACK_START.x+2*GX,y:PACK_START.y+4*GY,cap:80},
  "T5":{x:PACK_START.x+3*GX,y:PACK_START.y+4*GY,cap:80},
  "T4":{x:PACK_START.x+4*GX,y:PACK_START.y+4*GY,cap:80},
  "T3":{x:PACK_START.x+5*GX,y:PACK_START.y+4*GY,cap:80},
  "T2":{x:PACK_START.x+6*GX,y:PACK_START.y+4*GY,cap:80},
  "T1":{x:PACK_START.x+7*GX,y:PACK_START.y+4*GY,cap:80},

  /* L1~L6 (보라) */
  "L1":{x:L16_START.x+0*GX,y:L16_START.y,cap:25},
  "L2":{x:L16_START.x+1*GX,y:L16_START.y,cap:25},
  "L3":{x:L16_START.x+2*GX,y:L16_START.y,cap:25},
  "L4":{x:L16_START.x+3*GX,y:L16_START.y,cap:25},
  "L5":{x:L16_START.x+4*GX,y:L16_START.y,cap:25},
  "L6":{x:L16_START.x+5*GX,y:L16_START.y,cap:25},

  /* B1~B4 (녹색 원) */
  "B4":{x:B_START.x+0*B_GX,y:B_START.y-1*B_GY,cap:35},
  "B1":{x:B_START.x+1*B_GX,y:B_START.y-1*B_GY,cap:35},
  "B3":{x:B_START.x+0*B_GX,y:B_START.y+0*B_GY,cap:35},
  "B2":{x:B_START.x+1*B_GX,y:B_START.y+0*B_GY,cap:35},

  /* 하단 Bulk Loading Bin */
  "L15":{x:BULK_BASE.x+0*GX,y:BULK_BASE.y+0*GY,cap:60},
  "L16":{x:BULK_BASE.x+1*GX,y:BULK_BASE.y+0*GY,cap:60},
  "L17":{x:BULK_BASE.x+2*GX,y:BULK_BASE.y+0*GY,cap:60},
  "L18":{x:BULK_BASE.x+3*GX,y:BULK_BASE.y+0*GY,cap:60},
  "L19":{x:BULK_BASE.x+4*GX,y:BULK_BASE.y+0*GY,cap:40},
  "L20":{x:BULK_BASE.x+5*GX,y:BULK_BASE.y+0*GY,cap:40},

  "L21":{x:BULK_BASE.x+0*GX,y:BULK_BASE.y+1*GY,cap:60},
  "L22":{x:BULK_BASE.x+1*GX,y:BULK_BASE.y+1*GY,cap:60},
  "L23":{x:BULK_BASE.x+2*GX,y:BULK_BASE.y+1*GY,cap:60},
  "L24":{x:BULK_BASE.x+3*GX,y:BULK_BASE.y+1*GY,cap:60},
  "L25":{x:BULK_BASE.x+4*GX,y:BULK_BASE.y+1*GY,cap:40},
  "L26":{x:BULK_BASE.x+5*GX,y:BULK_BASE.y+1*GY,cap:40},

  "L8": {x:BULK_BASE.x+6*GX,y:BULK_BASE.y+0*GY,cap:80},
  "L7": {x:BULK_BASE.x+7*GX,y:BULK_BASE.y+0*GY,cap:80},
  "L10":{x:BULK_BASE.x+6*GX,y:BULK_BASE.y+1*GY,cap:80},
  "L9": {x:BULK_BASE.x+7*GX,y:BULK_BASE.y+1*GY,cap:80},

  "L12":{x:BULK_BASE.x+6*GX,y:BULK_BASE.y+2*GY,cap:80},
  "L11":{x:BULK_BASE.x+7*GX,y:BULK_BASE.y+2*GY,cap:80},
  "L14":{x:BULK_BASE.x+6*GX,y:BULK_BASE.y+3*GY,cap:80},
  "L13":{x:BULK_BASE.x+7*GX,y:BULK_BASE.y+3*GY,cap:80},
};

/* ✅ Br 사각 탱크 레이아웃 생성 */
function buildBrLayout(){
  const layout = {};

  const labels = {Br12:"30t",Br11:"30t",Br10:"30t",Br9:"30t",Br8:"40t",Br7:"40t",Br6:"40t",Br5:"40t"};
  const order = ["Br12","Br11","Br10","Br9","Br8","Br7","Br6","Br5"];

  const startX = brRowStartX();
  for(let i=0;i<order.length;i++){
    const name = order[i];
    layout[name] = {
      x: startX + i*(BR_BOX_W + BR_STEP),
      y: BR_LINE_Y,
      w: BR_BOX_W,
      h: BR_BOX_H,
      label: labels[name]
    };
  }

  // Br4~Br1: branArea 좌우와 일치
  const colW = Z.branArea.w;
  const colX = Z.branArea.x;
  const colH = 62;
  const vGap = 4;

  const vOrder = ["Br4","Br3","Br2","Br1"];
  for(let i=0;i<vOrder.length;i++){
    const name = vOrder[i];
    layout[name] = {
      x: colX,
      y: BR_COL_Y + i*(colH+vGap),
      w: colW,
      h: colH,
      label: "100t"
    };
  }

  return layout;
}
const brLayout = buildBrLayout();

function strokeColorByTank(name){
  if(name.startsWith("A") || name.startsWith("1P") || name.startsWith("2P") || name.startsWith("3P")) return "#d10000";
  if(name.startsWith("T")) return "#0066cc";
  if(["L1","L2","L3","L4","L5","L6"].includes(name)) return "#7a2bd1";
  if(name.startsWith("L")) return "#0066cc";
  if(name.startsWith("B")) return "#00a651";
  return "#111";
}

function addSvg(tag, attrs={}, text=""){
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for(const k in attrs) el.setAttribute(k, attrs[k]);
  if(text) el.textContent = text;
  svg.appendChild(el);
  return el;
}

function drawZones(){
  svg.innerHTML = "";

  addSvg("rect",{class:"zone",x:Z.outer.x,y:Z.outer.y,width:Z.outer.w,height:Z.outer.h});

  addSvg("rect",{class:"zone",x:Z.pack.x,y:Z.pack.y,width:Z.pack.w,height:Z.pack.h});
  addSvg("rect",{class:"zone",x:Z.office.x,y:Z.office.y,width:Z.office.w,height:Z.office.h});
  addSvg("rect",{class:"zone",x:Z.newMill.x,y:Z.newMill.y,width:Z.newMill.w,height:Z.newMill.h});
  addSvg("rect",{class:"zone",x:Z.pillar.x,y:Z.pillar.y,width:Z.pillar.w,height:Z.pillar.h});
  addSvg("rect",{class:"zone",x:Z.oldMill.x,y:Z.oldMill.y,width:Z.oldMill.w,height:Z.oldMill.h});
  addSvg("rect",{class:"zone",x:Z.branArea.x,y:Z.branArea.y,width:Z.branArea.w,height:Z.branArea.h});

  addSvg("text",{x:Z.office.x+45,y:Z.office.y+250,transform:`rotate(90 ${Z.office.x+45} ${Z.office.y+250})`,fontSize:"26",fontWeight:"700",fill:"#111"}, "OFFICE");

  addSvg("text",{class:"zoneTitle",x:Z.newMill.x+140,y:Z.newMill.y+210}, "Milling Area (New)");
  addSvg("text",{class:"zoneTitle",x:Z.oldMill.x+140,y:Z.oldMill.y+210}, "Milling Area (Old)");

  addSvg("text",{class:"zoneNoteRed",x:Z.pack.x+30,y:Z.pack.y+35}, "Packaging Bin : 45M/T x 24Q'ty = 1080M/T");
  addSvg("text",{class:"zoneNoteRed",x:Z.pack.x+165,y:Z.pack.y+62}, "80M/T x 6Q'ty = 450M/T");
  addSvg("text",{class:"zoneNoteBlue",x:Z.pack.x+30,y:Z.pack.y+92}, "Bulk Loding Bin : 80M/T x 6Q'ty = 420M/T");

  /* (3) 보라색 글씨: 왼쪽 -90px, 아래 +60px */
  addSvg("text",{class:"zoneNotePurple",x:(Z.newMill.x+70)-90,y:(Z.newMill.y+380)+60},
    "Semi-finished Bin : 25M/T x 6Q'ty = 150M/T");

  addSvg("text",{
    class:"zoneNoteGreen",
    x:Z.newMill.x + 300,
    y:Z.newMill.y + Z.newMill.h + 30
  }, "Primix Bin : 35M/T x 4Q'ty = 140M/T");

  addSvg("text",{x:Z.oldMill.x+35,y:Z.oldMill.y+380,fontSize:"20",fontWeight:"900",fill:"#111"},
    "Bran byproduct Bin : 30M/T x 8Q'ty = 240M/T");

  addSvg("text",{x:Z.oldMill.x+450,y:Z.oldMill.y+610,fontSize:"22",fontWeight:"900",fill:"#111"}, "Bran byproduct Bin :");
  addSvg("text",{x:Z.oldMill.x+420,y:Z.oldMill.y+640,fontSize:"22",fontWeight:"900",fill:"#111"}, "100M/T x 4Q'ty = 400M/T");

  addSvg("text",{class:"zoneNoteBlue",x:760,y:985}, "Bulk Loding Bin : 40M/T x 12Q'ty + 80M/T x 8Q'ty = 1600M/T");
}

function drawBranBig(){
  const cx = Z.branArea.x + Z.branArea.w/2;
  const cy = Z.branArea.y + 110;
  addSvg("circle",{cx,cy,r:58,stroke:"#111","stroke-width":3,fill:"#fff"});
  addSvg("text",{x:cx,y:cy-10,fontSize:"22",fontWeight:"900",textAnchor:"middle"},"Bran");
  addSvg("text",{x:cx,y:cy+18,fontSize:"22",fontWeight:"900",textAnchor:"middle"},"400t");
}

function drawCircleTank(name, x, y){
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("class","tank");
  g.setAttribute("id","tank_"+name);

  const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx",x);
  c.setAttribute("cy",y);
  c.setAttribute("r",R);
  c.setAttribute("stroke", strokeColorByTank(name));

  const nm = document.createElementNS("http://www.w3.org/2000/svg","text");
  nm.setAttribute("class","name");
  nm.setAttribute("x",x);
  nm.setAttribute("y",y-12);
  nm.setAttribute("fill", strokeColorByTank(name));
  nm.textContent = name;

  const qt = document.createElementNS("http://www.w3.org/2000/svg","text");
  qt.setAttribute("class","qty");
  qt.setAttribute("x",x);
  qt.setAttribute("y",y+10);
  qt.setAttribute("id","qty_"+name);
  qt.textContent = "-";

  const pct = document.createElementNS("http://www.w3.org/2000/svg","text");
  pct.setAttribute("class","pct");
  pct.setAttribute("x",x);
  pct.setAttribute("y",y+30);
  pct.setAttribute("id","pct_"+name);
  pct.textContent = "";

  g.appendChild(c); g.appendChild(nm); g.appendChild(qt); g.appendChild(pct);
  svg.appendChild(g);
}

function drawBrTank(name, x, y, w, h, label){
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("class","brtank");
  g.setAttribute("id","br_"+name);

  const r = document.createElementNS("http://www.w3.org/2000/svg","rect");
  r.setAttribute("x",x);
  r.setAttribute("y",y);
  r.setAttribute("width",w);
  r.setAttribute("height",h);

  const nm = document.createElementNS("http://www.w3.org/2000/svg","text");
  nm.setAttribute("class","nm");
  nm.setAttribute("x",x+w/2);
  nm.setAttribute("y",y+h/2-8);
  nm.textContent = name;

  const qt = document.createElementNS("http://www.w3.org/2000/svg","text");
  qt.setAttribute("class","qt");
  qt.setAttribute("x",x+w/2);
  qt.setAttribute("y",y+h/2+14);
  qt.textContent = label || "";

  g.appendChild(r); g.appendChild(nm); g.appendChild(qt);
  svg.appendChild(g);
}

/* Raw 파싱(새 형식) */
function normalizeTankId(s){
  return (s||"").toString().replace(/\s+/g,"").trim();
}
function parseNumber(s){
  if(s===null || s===undefined) return 0;
  const v = s.toString().replace(/,/g,"").trim();
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}
function parseRaw(raw){
  const lines = raw.trim().split(/\r?\n/);
  const data = {};
  for(const line of lines){
    const cols = line.split("\t");
    if(cols.length < 3) continue;

    const tank = normalizeTankId(cols[0]);
    if(!tank) continue;

    if(!tankLayout[tank]) continue;

    const qtyT = parseNumber(cols[2]);
    const product = (cols[4]||"").trim();
    data[tank] = { qty: qtyT, product };
  }
  return data;
}

function render(data){
  for(const name in tankLayout){
    const layout = tankLayout[name];
    const g = document.getElementById("tank_"+name);
    const qtyEl = document.getElementById("qty_"+name);
    const pctEl = document.getElementById("pct_"+name);

    let qty = 0;
    if(data && data[name]) qty = data[name].qty;

    const percent = layout.cap ? Math.round((qty/layout.cap)*100) : 0;

    qtyEl.textContent = `${qty}t`;
    pctEl.textContent = layout.cap ? `(${percent}%)` : "";

    g.classList.remove("zero","over85");
    if(qty === 0) g.classList.add("zero");
    if(layout.cap && percent >= 85) g.classList.add("over85");
  }
}

/* 날짜 저장/조회 */
function todayStr(){ return new Date().toISOString().slice(0,10); }

function saveData(){
  const raw = document.getElementById("rawData").value;
  if(!raw.trim()){ alert("Raw data를 붙여넣어 주세요."); return; }
  const date = todayStr();
  const parsed = parseRaw(raw);
  localStorage.setItem("tank_"+date, JSON.stringify(parsed));
  alert("저장 완료 : " + date);
  render(parsed);
}

function loadByDate(){
  const date = document.getElementById("datePicker").value;
  if(!date){ alert("날짜를 선택해 주세요."); return; }
  const saved = localStorage.getItem("tank_"+date);
  if(!saved){ alert("해당 날짜 데이터가 없습니다."); return; }
  render(JSON.parse(saved));
}

function init(){
  drawZones();
  drawBranBig();

  for(const name in tankLayout){
    const t = tankLayout[name];
    drawCircleTank(name, t.x, t.y);
  }

  for(const name in brLayout){
    const b = brLayout[name];
    drawBrTank(name, b.x, b.y, b.w, b.h, b.label);
  }

  const saved = localStorage.getItem("tank_"+todayStr());
  if(saved) render(JSON.parse(saved));
}
init();
</script>
</body>
</html>
