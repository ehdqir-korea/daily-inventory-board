<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탱크 재고 현황</title>
<style>
body{font-family:Arial;margin:0;background:#f4f4f4}
.controls{padding:15px;background:white}
textarea{width:100%;height:160px}
button{padding:8px 14px;margin-right:10px;margin-top:5px}
svg{background:white;border:2px solid #333}

/* 탱크 스타일 */
.tank circle{
  stroke-width:2;
  fill:white;
}
.zero circle{fill:#fff9c4;}        /* 0일때 연노랑 */
.over85 circle{fill:#ffd6d6;}      /* 85%이상 연빨강 */
.tank text{font-size:12px;text-anchor:middle;dominant-baseline:middle;font-weight:bold}
.capacity{font-size:10px;fill:#666}
.percent{font-size:10px;fill:#000}
</style>
</head>
<body>

<div class="controls">
  <h3>Raw Data 입력 (새 형식)</h3>
  <textarea id="rawData"></textarea><br>
  <button onclick="saveData()">저장</button>
  <input type="date" id="datePicker">
  <button onclick="loadByDate()">날짜조회</button>
</div>

<svg id="canvas" width="1422" height="725"></svg>

<script>

/* ==========================
   1. 탱크 배치 정의
========================== */

const tankLayout = {
"A6":{x:90,y:120,cap:80},"A5":{x:150,y:120,cap:80},"3P8":{x:210,y:120,cap:45},"3P7":{x:270,y:120,cap:45},"2P8":{x:330,y:120,cap:45},"2P7":{x:390,y:120,cap:45},"1P8":{x:450,y:120,cap:45},"1P7":{x:510,y:120,cap:45},

"A4":{x:90,y:170,cap:80},"A3":{x:150,y:170,cap:80},"3P6":{x:210,y:170,cap:45},"3P5":{x:270,y:170,cap:45},"2P6":{x:330,y:170,cap:45},"2P5":{x:390,y:170,cap:45},"1P6":{x:450,y:170,cap:45},"1P5":{x:510,y:170,cap:45},

"A2":{x:90,y:220,cap:80},"A1":{x:150,y:220,cap:80},"3P4":{x:210,y:220,cap:45},"3P3":{x:270,y:220,cap:45},"2P4":{x:330,y:220,cap:45},"2P3":{x:390,y:220,cap:45},"1P4":{x:450,y:220,cap:45},"1P3":{x:510,y:220,cap:45},

"3P2":{x:210,y:270,cap:45},"3P1":{x:270,y:270,cap:45},"2P2":{x:330,y:270,cap:45},"2P1":{x:390,y:270,cap:45},"1P2":{x:450,y:270,cap:45},"1P1":{x:510,y:270,cap:45},

"T6":{x:210,y:320,cap:80},"T5":{x:270,y:320,cap:80},"T4":{x:330,y:320,cap:80},"T3":{x:390,y:320,cap:80},"T2":{x:450,y:320,cap:80},"T1":{x:510,y:320,cap:80},

"L1":{x:500,y:350,cap:25},"L2":{x:560,y:350,cap:25},"L3":{x:620,y:350,cap:25},"L4":{x:680,y:350,cap:25},"L5":{x:740,y:350,cap:25},"L6":{x:800,y:350,cap:25},

"L15":{x:650,y:430,cap:60},"L16":{x:710,y:430,cap:60},"L17":{x:770,y:430,cap:60},"L18":{x:830,y:430,cap:40},"L19":{x:890,y:430,cap:40},"L20":{x:950,y:430,cap:40},

"L21":{x:650,y:480,cap:60},"L22":{x:710,y:480,cap:60},"L23":{x:770,y:480,cap:60},"L24":{x:830,y:480,cap:60},"L25":{x:890,y:480,cap:40},"L26":{x:950,y:480,cap:40},

"L10":{x:1010,y:480,cap:80},"L9":{x:1070,y:480,cap:80},
"L12":{x:1010,y:530,cap:80},"L11":{x:1070,y:530,cap:80},
"L14":{x:1010,y:580,cap:80},"L13":{x:1070,y:580,cap:80}
};

/* ==========================
   2. SVG 생성
========================== */

const svg=document.getElementById("canvas");

/* 상단 문구 */
svg.innerHTML += `
<text x="40" y="30" fill="red" font-weight="bold">Packaging Bin : </text>
<text x="175" y="30" fill="red" font-weight="bold">45M/T x 24Q'ty = 1080M/T</text>
<text x="175" y="55" fill="red" font-weight="bold">80M/T x 6Q'ty = 450M/T</text>
<text x="40" y="80" fill="blue" font-weight="bold">Bulk Loding Bin : 80M/T x 6Q'ty = 420M/T</text>
`;

/* 탱크 생성 */
for(const name in tankLayout){
  const t=tankLayout[name];
  const g=document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("class","tank");
  g.setAttribute("id","tank_"+name);

  const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx",t.x);
  c.setAttribute("cy",t.y);
  c.setAttribute("r",23);

  const label=document.createElementNS("http://www.w3.org/2000/svg","text");
  label.setAttribute("x",t.x);
  label.setAttribute("y",t.y-8);
  label.textContent=name;

  const qty=document.createElementNS("http://www.w3.org/2000/svg","text");
  qty.setAttribute("x",t.x);
  qty.setAttribute("y",t.y+6);
  qty.setAttribute("id","qty_"+name);

  const pct=document.createElementNS("http://www.w3.org/2000/svg","text");
  pct.setAttribute("x",t.x);
  pct.setAttribute("y",t.y+18);
  pct.setAttribute("id","pct_"+name);
  pct.setAttribute("class","percent");

  g.appendChild(c);
  g.appendChild(label);
  g.appendChild(qty);
  g.appendChild(pct);
  svg.appendChild(g);
}

/* ==========================
   3. 데이터 파싱 (새 Raw 형식)
========================== */

function parseRaw(raw){
  const lines=raw.trim().split("\n");
  const data={};

  lines.forEach(line=>{
    const cols=line.split("\t");
    if(cols.length<3) return;

    let tank=cols[0].replace(/\s/g,"");
    let amount=parseFloat(cols[2])||0;
    let product=cols[4]||"";

    if(!tankLayout[tank]) return; // 이미지에 없는 탱크 무시

    data[tank]={qty:amount,product:product};
  });

  return data;
}

/* ==========================
   4. 화면 반영
========================== */

function render(data){
  for(const name in tankLayout){
    const layout=tankLayout[name];
    const g=document.getElementById("tank_"+name);
    const qtyEl=document.getElementById("qty_"+name);
    const pctEl=document.getElementById("pct_"+name);

    let qty=0;
    if(data[name]) qty=data[name].qty;

    let percent=layout.cap?Math.round((qty/layout.cap)*100):0;

    qtyEl.textContent=qty+"t";
    pctEl.textContent="("+percent+"%)";

    g.classList.remove("zero","over85");
    if(qty===0) g.classList.add("zero");
    if(percent>=85) g.classList.add("over85");
  }
}

/* ==========================
   5. 저장/조회 (DB화)
========================== */

function saveData(){
  const raw=document.getElementById("rawData").value;
  const date=new Date().toISOString().slice(0,10);
  const parsed=parseRaw(raw);

  localStorage.setItem("tank_"+date,JSON.stringify(parsed));
  alert("저장 완료 : "+date);
  render(parsed);
}

function loadByDate(){
  const date=document.getElementById("datePicker").value;
  if(!date) return;

  const saved=localStorage.getItem("tank_"+date);
  if(!saved){ alert("데이터 없음"); return; }

  render(JSON.parse(saved));
}

</script>
</body>
</html>
