<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>일일재고현황표</title>
  <style>
    :root{
      --line:#111;
      --blue:#1f5cff;
      --orange:#cc6a00;
      --green:#7aa63a;
      --zero:#ffd6de;

      /* ===== 보기 좋게(겹침 방지) ===== */
      --cellH: 150px;      /* 사각형 1칸 높이(↑) */
      --circleD: 96px;     /* 원 지름(↓) */
      --outerPad: 10px;    /* 원 잘림 방지 여백 */
      --padTop: calc(var(--circleD)/2 + var(--outerPad));
      --padBottom: calc(var(--circleD)/2 + var(--outerPad));
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo","Noto Sans KR", Arial, sans-serif;
      margin: 18px;
      color:#111;
    }

    textarea{
      width:100%;
      min-height:150px;
      padding:12px;
      font-size:14px;
      border:1px solid #ccc;
      border-radius:10px;
      outline:none;
      box-sizing:border-box;
      white-space:pre-wrap;
    }
    .bar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin:10px 0 10px;
    }
    button{
      border:1px solid #222;
      background:#111;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:900;
    }
    button.secondary{ background:#fff; color:#111; }

    .legend{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 6px 0 10px;
      font-size:13px; color:#333;
    }
    .pill{
      border:1px solid #ccc;
      padding:4px 8px;
      border-radius:999px;
      background:#fafafa;
    }

    .title{
      text-align:center;
      font-size:44px;
      font-weight:900;
      letter-spacing:14px;
      margin:16px 0 12px;
    }

    .note{
      font-size:13px;
      color:#444;
      line-height:1.55;
      margin-bottom:10px;
    }

    /* ===== 도면 ===== */
    .wrap{ display:flex; justify-content:center; }
    .board{
      width: 980px;
      max-width: 100%;
      border:2px solid var(--line);
      padding: 16px 16px 20px;
      box-sizing:border-box;
      background:#fff;
    }

    .stage{
      position:relative;
      padding-top: var(--padTop);
      padding-bottom: var(--padBottom);
    }

    /* 7칸 x 2줄 = 14개 */
    .grid{
      position:relative;
      width: 100%;
      height: calc(var(--cellH) * 2);
      border:2px solid var(--line);
      box-sizing:border-box;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(2, 1fr);
      overflow: visible;
      background:#fff;
    }
    .cell{
      border:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      background:#fff;
      position:relative;
      z-index:1;
    }
    .cell.zero{ background: var(--zero); }

    /* 사각형 텍스트(크기 ↓, 겹침 방지) */
    .box{
      text-align:center;
      line-height:1.08;
      transform: translateY(2px);
    }
    .t-code{
      font-weight:900;
      font-size:16px;       /* ↓ */
      color:var(--blue);
      letter-spacing:0.2px;
    }
    .t-code.orange{ color:var(--orange); }

    .t-qty{
      font-weight:900;
      font-size:16px;       /* ↓ */
      margin-top:4px;
      color:#000;
    }
    .t-loc{
      font-weight:900;
      font-size:15px;       /* ↓ */
      margin-top:6px;
      color:var(--green);
    }

    /* ===== 원 6x3 = 18개 (교차점 중앙) ===== */
    .circles{
      position:absolute;
      left:0;
      top:0;
      width:100%;
      height: calc(var(--padTop) + (var(--cellH) * 2) + var(--padBottom));
      pointer-events:none;
      z-index:3;
      overflow: visible;
    }
    .circle{
      position:absolute;
      width: var(--circleD);
      height: var(--circleD);
      border:2px solid var(--line);
      border-radius:999px;
      background:#fff;
      transform: translate(-50%, -50%);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:5px;
      box-sizing:border-box;
      line-height:1.06;
    }
    .circle.zero{ background: var(--zero); }

    .c-code{
      font-weight:900;
      font-size:18px;      /* ↓ */
      color:var(--blue);
      letter-spacing:0.2px;
      white-space:nowrap;
    }
    .c-code.orange{ color:var(--orange); }

    .c-qty{
      font-weight:900;
      font-size:17px;      /* ↓ */
      color:#000;
    }
    .c-loc{
      font-weight:900;
      font-size:16px;      /* ↓ */
      color:var(--green);
    }
  </style>
</head>
<body>

  <div class="note">
    <b>사용법</b><br/>
    1) 엑셀에서 표 복사(Ctrl+C) → 아래 칸에 붙여넣기(Ctrl+V)<br/>
    2) <b>현황표 업데이트</b> 클릭<br/>
    ※ 이 페이지는 붙여넣은 텍스트에서 <b>A코드 기준</b>으로 자동 배치합니다. (예: <b>A101 WUR 1,600.000</b>)
  </div>

  <textarea id="paste" placeholder="여기에 엑셀에서 복사한 내용을 그대로 붙여넣으세요."></textarea>

  <div class="bar">
    <button id="btnMap">현황표 업데이트</button>
    <button class="secondary" id="btnClear">초기화</button>
    <button class="secondary" id="btnDemo">데모</button>
  </div>

  <div class="legend">
    <span class="pill"><b style="color:var(--orange)">WCRS/WUR/WNS</b> → 주황색</span>
    <span class="pill"><b style="background:var(--zero); padding:2px 6px; border-radius:6px;">수량 0</b> → 배경 강조</span>
    <span class="pill">수량 자동 <b>콤마</b></span>
  </div>

  <div class="title">일 일 재 고 현 황 표</div>

  <div class="wrap">
    <div class="board">
      <div class="stage">
        <div class="grid" id="grid">
          <div class="circles" id="circles"></div>
          <!-- 14 cells appended by JS -->
        </div>
      </div>
    </div>
  </div>

<script>
  const ORANGE = new Set(["WCRS","WUR","WNS"]);
  const fmt = new Intl.NumberFormat("en-US");

  // 원 위치: A101~A106 / A301~A306 / A501~A506
  const CIRCLE_LOCS = [
    "A101","A102","A103","A104","A105","A106",
    "A301","A302","A303","A304","A305","A306",
    "A501","A502","A503","A504","A505","A506",
  ];

  // 사각형 위치: 윗줄 A201~A207 / 아랫줄 A401~A407
  const RECT_TOP = ["A201","A202","A203","A204","A205","A206","A207"];
  const RECT_BOT = ["A401","A402","A403","A404","A405","A406","A407"];

  const grid = document.getElementById("grid");
  const circlesLayer = document.getElementById("circles");

  // ===== 사각형 14개 생성 =====
  const rectCells = [];
  function makeCell(){
    const cell = document.createElement("div");
    cell.className = "cell";

    const box = document.createElement("div");
    box.className = "box";

    const code = document.createElement("div");
    code.className = "t-code";
    const qty = document.createElement("div");
    qty.className = "t-qty";
    const loc = document.createElement("div");
    loc.className = "t-loc";

    box.appendChild(code);
    box.appendChild(qty);
    box.appendChild(loc);
    cell.appendChild(box);

    return { cell, code, qty, loc };
  }

  for(let i=0;i<14;i++){
    const it = makeCell();
    grid.appendChild(it.cell);
    rectCells.push(it);
  }

  // ===== 원 18개 생성 + 교차점 배치(겹침 줄인 크기) =====
  const circles = [];
  function makeCircle(){
    const el = document.createElement("div");
    el.className = "circle";

    const code = document.createElement("div");
    code.className = "c-code";
    const qty = document.createElement("div");
    qty.className = "c-qty";
    const loc = document.createElement("div");
    loc.className = "c-loc";

    el.appendChild(code);
    el.appendChild(qty);
    el.appendChild(loc);
    circlesLayer.appendChild(el);

    return { el, code, qty, loc };
  }

  // x = (1..6)/7, y = padTop + (0..2)/2 * (2*cellH)
  for(let r=0; r<3; r++){
    for(let c=0; c<6; c++){
      const it = makeCircle();

      const xPct = ((c+1)/7) * 100;     // 6개의 내부 세로선
      const yPct = (r/2) * 100;         // 0,50,100 (grid 기준)

      it.el.style.left = xPct + "%";
      it.el.style.top  = `calc(var(--padTop) + ${yPct}% )`;

      circles.push(it);
    }
  }

  // ===== 렌더링 =====
  function applyStyle(codeEl, container, code, qty){
    const cd = String(code ?? "—").trim();
    codeEl.textContent = cd;
    codeEl.classList.toggle("orange", ORANGE.has(cd));

    const n = Number(String(qty ?? "").replaceAll(",","").trim());
    const isNum = Number.isFinite(n);
    container.classList.toggle("zero", isNum && n === 0);
    return { isNum, n };
  }

  function setRect(i, loc, data){
    const it = rectCells[i];
    const code = data?.code ?? "—";
    const qty  = data?.qty  ?? "—";
    const {isNum, n} = applyStyle(it.code, it.cell, code, qty);
    it.qty.textContent = isNum ? fmt.format(n) : qty;
    it.loc.textContent = loc;
  }

  function setCircle(i, loc, data){
    const it = circles[i];
    const code = data?.code ?? "—";
    const qty  = data?.qty  ?? "—";
    const {isNum, n} = applyStyle(it.code, it.el, code, qty);
    it.qty.textContent = isNum ? fmt.format(n) : qty;
    it.loc.textContent = loc;
  }

  function reset(){
    RECT_TOP.forEach((loc, idx)=> setRect(idx, loc, null));
    RECT_BOT.forEach((loc, idx)=> setRect(7+idx, loc, null));
    CIRCLE_LOCS.forEach((loc, idx)=> setCircle(idx, loc, null));
  }

  // ===== 파싱(핵심 수정): A코드가 먼저 오는 형식을 우선 지원 =====
  // 지원 형식:
  // 1) A101 WUR 1,600.000  (너의 RAW)
  // 2) WUR 1,600.000 A101  (예전 방식도 호환)
  function parseMap(text){
    const lines = text.split(/\r?\n/).map(v => v.trim()).filter(Boolean);
    const map = new Map();

    // 1) 라인 단위로 "A### CODE QTY" 먼저 잡기 (가장 정확)
    for(const line of lines){
      // A코드, 코드, 숫자(콤마/소수) 허용
      const m = line.match(/\b(A\d{3})\b\s+([A-Z]{2,12}[A-Z0-9.]*)\s+([-]?\d[\d,]*\.?\d*)/);
      if(m){
        const loc = m[1];
        const code = m[2];
        const qty = m[3];
        map.set(loc, {code, qty});
      }
    }

    // 2) 혹시 표 전체를 붙여넣어서 라인 매칭이 누락될 때 대비(토큰 스캔)
    if(map.size === 0){
      const tokenRe = /\b(A\d{3})\b|([A-Z]{2,12}[A-Z0-9.]*)|([-]?\d[\d,]*\.?\d*)/g;
      const tokens = [];
      let mm;
      while((mm = tokenRe.exec(text)) !== null){
        tokens.push(mm[0]);
      }

      // 패턴1: A### CODE QTY
      for(let i=0;i<tokens.length-2;i++){
        if(/^A\d{3}$/.test(tokens[i]) && /^[A-Z]{2,12}[A-Z0-9.]*$/.test(tokens[i+1]) && /^-?\d/.test(tokens[i+2])){
          map.set(tokens[i], {code: tokens[i+1], qty: tokens[i+2]});
        }
      }
      // 패턴2: CODE QTY A###
      for(let i=0;i<tokens.length-2;i++){
        if(/^[A-Z]{2,12}[A-Z0-9.]*$/.test(tokens[i]) && /^-?\d/.test(tokens[i+1]) && /^A\d{3}$/.test(tokens[i+2])){
          if(!map.has(tokens[i+2])) map.set(tokens[i+2], {code: tokens[i], qty: tokens[i+1]});
        }
      }
    }

    return map;
  }

  function render(map){
    RECT_TOP.forEach((loc, idx)=> setRect(idx, loc, map.get(loc)));
    RECT_BOT.forEach((loc, idx)=> setRect(7+idx, loc, map.get(loc)));
    CIRCLE_LOCS.forEach((loc, idx)=> setCircle(idx, loc, map.get(loc)));
  }

  // ===== 버튼 =====
  document.getElementById("btnMap").addEventListener("click", ()=>{
    const text = document.getElementById("paste").value || "";
    const map = parseMap(text);

    reset();
    render(map);

    const must = [...RECT_TOP, ...RECT_BOT, ...CIRCLE_LOCS];
    const missing = must.filter(k => !map.has(k));
    if(missing.length){
      alert(`누락된 A코드(${missing.length}개):\n${missing.join(", ")}`);
    }
  });

  document.getElementById("btnClear").addEventListener("click", ()=>{
    document.getElementById("paste").value = "";
    reset();
  });

  document.getElementById("btnDemo").addEventListener("click", ()=>{
    document.getElementById("paste").value = `
A101 WUR 1,600.000
A102 WCRS 1,700.557
A103 WASW 1,360.392
A104 WASWP 1,403.039
A105 WUR 1,700.915
A106 WNS 1,637.684

A201 WUSL9.0 146.960
A202 WUSH 420.000
A203 WUR 420.679
A204 WUR 420.233
A205 WUSH 420.000
A206 WUSL9.0 419.860
A207 WUR 158.126

A301 WUSH 864.386
A302 WUSH 1,695.227
A303 WUSH 1,671.185
A304 WUSH 1,690.285
A305 WNS 1,697.176
A306 WUR 1,701.166

A401 WCRS 170.000
A402 WUSH 410.000
A403 WUSH 0.000
A404 WNS 419.287
A405 WUSH 0.000
A406 WUSH 0.000
A407 WNS 170.000

A501 WUSH 1,557.437
A502 WNS 1,703.834
A503 WUSH 1,645.290
A504 WCRS 956.294
A505 WASWP 1,696.740
A506 WUR 1,700.906
`.trim();
  });

  reset();
</script>
</body>
</html>
