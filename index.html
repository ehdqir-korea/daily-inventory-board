<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탱크 재고 현황</title>
<style>
  body{font-family:Arial;margin:0;background:#f4f4f4}
  .controls{padding:15px;background:white}
  textarea{width:100%;height:170px}
  button{padding:8px 14px;margin-right:10px;margin-top:6px}
  input[type="date"]{padding:6px 10px;margin-top:6px}
  svg{background:white;border:2px solid #333}

  /* 탱크 스타일 */
  .tank circle{stroke-width:2; fill:white;}
  .zero circle{fill:#fff9c4;}        /* 0일때 연노랑 */
  .over85 circle{fill:#ffd6d6;}      /* 85%이상 연빨강 */
  .tank text{font-size:12px;text-anchor:middle;dominant-baseline:middle;font-weight:bold}
  .percent{font-size:10px;fill:#000}
</style>
</head>
<body>

<div class="controls">
  <h3>Raw Data 입력 (새 형식: TANK NO / 측정량 / 제품명)</h3>
  <div style="color:#666;font-size:13px;line-height:1.4">
    - 엑셀에서 표 범위 복사 → 아래에 붙여넣기<br>
    - 탱크 번호는 예: <b>L  9</b>, <b>P1-1</b>, <b>A 1</b> 형태도 자동 인식합니다(공백 제거)<br>
    - 이미지에 없는 탱크 번호는 자동으로 무시합니다.
  </div>
  <textarea id="rawData" placeholder="여기에 붙여넣기 (탭 구분)"></textarea><br>
  <button onclick="saveData()">저장(오늘)</button>
  <input type="date" id="datePicker">
  <button onclick="loadByDate()">날짜조회</button>
</div>

<svg id="canvas" width="1422" height="725" viewBox="0 0 1422 725" preserveAspectRatio="xMinYMin meet"></svg>

<script>
/* =========================================================
   1) 탱크 배치(사진 기준 픽셀 정렬) + 용량(cap)
   - 반지름 r=23 기준
   - A/ P / T 블록 기준점: START_X=92, START_Y=132, GAP=60
   - L1~L6: L_START_X=585, L_START_Y=365, GAP=60
========================================================= */

const START_X = 92;
const START_Y = 132;
const GAP = 60;

const L_START_X = 585;
const L_START_Y = 365;

const tankLayout = {
  // ====== Packaging Bin (좌측 상단 빨강) ======
  "A6":{x:START_X+0*GAP,y:START_Y,cap:80},
  "A5":{x:START_X+1*GAP,y:START_Y,cap:80},
  "3P8":{x:START_X+2*GAP,y:START_Y,cap:45},
  "3P7":{x:START_X+3*GAP,y:START_Y,cap:45},
  "2P8":{x:START_X+4*GAP,y:START_Y,cap:45},
  "2P7":{x:START_X+5*GAP,y:START_Y,cap:45},
  "1P8":{x:START_X+6*GAP,y:START_Y,cap:45},
  "1P7":{x:START_X+7*GAP,y:START_Y,cap:45},

  "A4":{x:START_X+0*GAP,y:START_Y+50,cap:80},
  "A3":{x:START_X+1*GAP,y:START_Y+50,cap:80},
  "3P6":{x:START_X+2*GAP,y:START_Y+50,cap:45},
  "3P5":{x:START_X+3*GAP,y:START_Y+50,cap:45},
  "2P6":{x:START_X+4*GAP,y:START_Y+50,cap:45},
  "2P5":{x:START_X+5*GAP,y:START_Y+50,cap:45},
  "1P6":{x:START_X+6*GAP,y:START_Y+50,cap:45},
  "1P5":{x:START_X+7*GAP,y:START_Y+50,cap:45},

  "A2":{x:START_X+0*GAP,y:START_Y+100,cap:80},
  "A1":{x:START_X+1*GAP,y:START_Y+100,cap:80},
  "3P4":{x:START_X+2*GAP,y:START_Y+100,cap:45},
  "3P3":{x:START_X+3*GAP,y:START_Y+100,cap:45},
  "2P4":{x:START_X+4*GAP,y:START_Y+100,cap:45},
  "2P3":{x:START_X+5*GAP,y:START_Y+100,cap:45},
  "1P4":{x:START_X+6*GAP,y:START_Y+100,cap:45},
  "1P3":{x:START_X+7*GAP,y:START_Y+100,cap:45},

  "3P2":{x:START_X+2*GAP,y:START_Y+150,cap:45},
  "3P1":{x:START_X+3*GAP,y:START_Y+150,cap:45},
  "2P2":{x:START_X+4*GAP,y:START_Y+150,cap:45},
  "2P1":{x:START_X+5*GAP,y:START_Y+150,cap:45},
  "1P2":{x:START_X+6*GAP,y:START_Y+150,cap:45},
  "1P1":{x:START_X+7*GAP,y:START_Y+150,cap:45},

  // ====== T 라인 (좌측 하단 파랑) ======
  "T6":{x:START_X+2*GAP,y:START_Y+200,cap:80},
  "T5":{x:START_X+3*GAP,y:START_Y+200,cap:80},
  "T4":{x:START_X+4*GAP,y:START_Y+200,cap:80},
  "T3":{x:START_X+5*GAP,y:START_Y+200,cap:80},
  "T2":{x:START_X+6*GAP,y:START_Y+200,cap:80},
  "T1":{x:START_X+7*GAP,y:START_Y+200,cap:80},

  // ====== L1~L6 (보라) ======
  "L1":{x:L_START_X+0*GAP,y:L_START_Y,cap:25},
  "L2":{x:L_START_X+1*GAP,y:L_START_Y,cap:25},
  "L3":{x:L_START_X+2*GAP,y:L_START_Y,cap:25},
  "L4":{x:L_START_X+3*GAP,y:L_START_Y,cap:25},
  "L5":{x:L_START_X+4*GAP,y:L_START_Y,cap:25},
  "L6":{x:L_START_X+5*GAP,y:L_START_Y,cap:25},

  // ====== 아래쪽 Bulk Loading Bin (파랑) — 필요 시 계속 미세조정 ======
  "L15":{x:650,y:460,cap:60},"L16":{x:710,y:460,cap:60},"L17":{x:770,y:460,cap:60},
  "L18":{x:830,y:460,cap:60},"L19":{x:890,y:460,cap:40},"L20":{x:950,y:460,cap:40},

  "L21":{x:650,y:515,cap:60},"L22":{x:710,y:515,cap:60},"L23":{x:770,y:515,cap:60},
  "L24":{x:830,y:515,cap:60},"L25":{x:890,y:515,cap:40},"L26":{x:950,y:515,cap:40},

  "L8":{x:1010,y:460,cap:80},"L7":{x:1070,y:460,cap:80},
  "L10":{x:1010,y:515,cap:80},"L9":{x:1070,y:515,cap:80},
  "L12":{x:1010,y:570,cap:80},"L11":{x:1070,y:570,cap:80},
  "L14":{x:1010,y:625,cap:80},"L13":{x:1070,y:625,cap:80},
};

/* =========================================================
   2) 색상/스타일 규칙
========================================================= */
function strokeColorByTank(name){
  if(/^A\d+$/.test(name) || /^\dP\d+$/.test(name) || /^P\d-\d$/.test(name) || /^P\d-\d+$/.test(name) || /^[123]P\d$/.test(name)){
    // A or 1P1 형태 일부가 섞일 수 있어 아래에서 그룹으로 다시 처리함
  }
  // 사진 기준 그룹 컬러 지정 (stroke)
  if(name.startsWith("A") || name.startsWith("1P") || name.startsWith("2P") || name.startsWith("3P")) return "#d40000"; // 빨강
  if(name.startsWith("T")) return "#0066cc"; // 파랑
  if(["L1","L2","L3","L4","L5","L6"].includes(name)) return "#7a2bd1"; // 보라
  // 나머지 L은 파랑으로
  if(name.startsWith("L")) return "#0066cc";
  // 기본
  return "#111";
}

/* =========================================================
   3) SVG 그리기
========================================================= */
const svg = document.getElementById("canvas");

// 상단 문구 (사진 정렬 픽셀값)
svg.innerHTML += `
  <text x="42" y="32" fill="red" font-weight="bold" font-size="18">Packaging Bin :</text>
  <text x="198" y="32" fill="red" font-weight="bold" font-size="18">45M/T x 24Q'ty = 1080M/T</text>
  <text x="198" y="56" fill="red" font-weight="bold" font-size="18">80M/T x 6Q'ty = 450M/T</text>
  <text x="42" y="80" fill="#0057d8" font-weight="bold" font-size="18">Bulk Loding Bin : 80M/T x 6Q'ty = 420M/T</text>
`;

// (선/구획은 추후 미세조정 단계에서 추가 가능)

// 탱크 생성
for(const name in tankLayout){
  const t = tankLayout[name];

  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("class","tank");
  g.setAttribute("id","tank_"+name);

  const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
  c.setAttribute("cx",t.x);
  c.setAttribute("cy",t.y);
  c.setAttribute("r",23);
  c.setAttribute("stroke", strokeColorByTank(name));

  const label = document.createElementNS("http://www.w3.org/2000/svg","text");
  label.setAttribute("x",t.x);
  label.setAttribute("y",t.y-8);
  label.setAttribute("fill", strokeColorByTank(name));
  label.textContent = name;

  const qty = document.createElementNS("http://www.w3.org/2000/svg","text");
  qty.setAttribute("x",t.x);
  qty.setAttribute("y",t.y+6);
  qty.setAttribute("id","qty_"+name);
  qty.textContent = "-";

  const pct = document.createElementNS("http://www.w3.org/2000/svg","text");
  pct.setAttribute("x",t.x);
  pct.setAttribute("y",t.y+18);
  pct.setAttribute("id","pct_"+name);
  pct.setAttribute("class","percent");
  pct.textContent = "";

  g.appendChild(c);
  g.appendChild(label);
  g.appendChild(qty);
  g.appendChild(pct);
  svg.appendChild(g);
}

/* =========================================================
   4) Raw Data 파싱(새 형식)
   - 탱크번호: cols[0] (TANK NO.)
   - 측정량: cols[2]
   - 제품명: cols[4]
   - 공백 제거해서 "L  9" => "L9", "A  1" => "A1", "T 6" => "T6"
   - 이미지에 없는 탱크는 무시
========================================================= */
function normalizeTankId(s){
  return (s||"").toString().replace(/\s+/g,"").trim();
}

function parseNumber(s){
  if(s===null || s===undefined) return 0;
  const v = s.toString().replace(/,/g,"").trim();
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}

function parseRaw(raw){
  const lines = raw.trim().split(/\r?\n/);
  const data = {};
  for(const line of lines){
    // 탭 기반이 기본, 혹시 공백+탭 섞이면 split("\t") 유지
    const cols = line.split("\t");
    if(cols.length < 3) continue;

    const tank = normalizeTankId(cols[0]);
    const qtyT = parseNumber(cols[2]);  // 측정량
    const product = (cols[4]||"").trim();

    if(!tank) continue;
    if(!tankLayout[tank]) continue; // 이미지에 없는 탱크 자동 무시

    data[tank] = { qty: qtyT, product };
  }
  return data;
}

/* =========================================================
   5) 화면 반영
   - qty는 t 단위로 표시 (이미 Raw가 t 단위로 들어온다고 가정)
   - percent = qty/cap
   - 0 => zero(연노랑)
   - >=85% => over85(연빨강)
========================================================= */
function render(data){
  for(const name in tankLayout){
    const layout = tankLayout[name];
    const g = document.getElementById("tank_"+name);
    const qtyEl = document.getElementById("qty_"+name);
    const pctEl = document.getElementById("pct_"+name);

    let qty = 0;
    if(data && data[name]) qty = data[name].qty;

    const percent = layout.cap ? Math.round((qty/layout.cap)*100) : 0;

    // 표시
    qtyEl.textContent = `${qty}t`;
    pctEl.textContent = layout.cap ? `(${percent}%)` : "";

    // 클래스 초기화
    g.classList.remove("zero","over85");
    if(qty === 0) g.classList.add("zero");
    if(percent >= 85) g.classList.add("over85");
  }
}

/* =========================================================
   6) 날짜별 저장/조회(localStorage)
========================================================= */
function todayStr(){
  return new Date().toISOString().slice(0,10);
}

function saveData(){
  const raw = document.getElementById("rawData").value;
  if(!raw.trim()){
    alert("Raw data를 붙여넣어 주세요.");
    return;
  }
  const date = todayStr();
  const parsed = parseRaw(raw);
  localStorage.setItem("tank_"+date, JSON.stringify(parsed));
  alert("저장 완료 : " + date);
  render(parsed);
}

function loadByDate(){
  const date = document.getElementById("datePicker").value;
  if(!date){
    alert("날짜를 선택해 주세요.");
    return;
  }
  const saved = localStorage.getItem("tank_"+date);
  if(!saved){
    alert("해당 날짜 데이터가 없습니다.");
    return;
  }
  render(JSON.parse(saved));
}

// 첫 로드시 오늘 데이터 있으면 자동 표시
(function init(){
  const saved = localStorage.getItem("tank_"+todayStr());
  if(saved) render(JSON.parse(saved));
})();
</script>
</body>
</html>
