<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>íƒ±í¬ ì¬ê³  í˜„í™© (ë³µë¶™ ìë™ + ë¯¸ì„¸ì¡°ì •)</title>
  <style>
    :root{
      --w:1422px;
      --h:725px;
      --line:#111;
      --bg:#fff;
      --zero:#fff5b1;
      --hi:#ffd3d3;
      --red:#d60000;
      --blue:#0b59ff;
      --purple:#6b35d4;
      --green:#00a24a;
      --gray:#333;
    }
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif; background:#f7f7f7; margin:0; padding:16px;}
    .wrap{max-width: calc(var(--w) + 540px); margin:0 auto; display:grid; grid-template-columns: 1fr 540px; gap:14px;}
    .card{background:#fff; border:1px solid #ddd; border-radius:10px; padding:12px;}
    h1{margin:0 0 10px; font-size:18px;}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px;}
    button{border:1px solid #bbb; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:800;}
    button.primary{background:#111; color:#fff; border-color:#111;}
    button.warn{background:#b00000; color:#fff; border-color:#b00000;}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #ddd; background:#fafafa; font-size:12px;}
    textarea{width:100%; height:180px; border:1px solid #ccc; border-radius:10px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; line-height:1.35;}
    .small{font-size:12px; color:#444; line-height:1.5;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .svgbox{overflow:auto; border:1px solid #ddd; border-radius:10px; background:#fff;}
    table{width:100%; border-collapse:collapse; font-size:12px;}
    th,td{border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align:top;}
    th{background:#fafafa;}
    .muted{color:#777;}
    .danger{color:#b00000; font-weight:900;}
    .tip{background:#fffdf2; border:1px solid #ffe08a; padding:10px; border-radius:10px; font-size:12px; line-height:1.5;}
    .kbd{border:1px solid #ddd; border-bottom-width:2px; background:#fafafa; padding:1px 6px; border-radius:6px; font-family:ui-monospace, Menlo, Consolas, monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>íƒ±í¬ ì¬ê³  í˜„í™© (ë³µë¶™ ìë™ + ë¯¸ì„¸ì¡°ì •)</h1>

      <div class="row">
        <button class="primary" id="btnApply">í˜„í™©í‘œ ì—…ë°ì´íŠ¸</button>
        <button id="btnSave">ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì €ì¥</button>
        <button id="btnClear">ì´ˆê¸°í™”</button>
        <span class="pill">âœ… <b>SVG ê³ ì •</b>: 1422Ã—725</span>
        <span class="pill">0 â†’ ë…¸ë‘ / 85%â†‘ â†’ ë¹¨ê°•</span>
      </div>

      <div class="row">
        <button id="btnEdit">ğŸ› ï¸ ë¯¸ì„¸ì¡°ì • ëª¨ë“œ: OFF</button>
        <button id="btnSnap">ìŠ¤ëƒ…: ON</button>
        <button id="btnExport">ì¢Œí‘œ ë‚´ë³´ë‚´ê¸°(í´ë¦½ë³´ë“œ)</button>
        <button class="warn" id="btnResetLayout">ì¢Œí‘œ ì´ˆê¸°í™”</button>
        <span class="pill muted">ë“œë˜ê·¸ë¡œ ìœ„ì¹˜ ì´ë™ â†’ ìë™ ì €ì¥</span>
      </div>

      <div class="row">
        <span class="pill">ì¡°íšŒ ë‚ ì§œ</span>
        <input type="date" id="datePick" />
        <button id="btnLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <span class="pill muted">ì €ì¥: PC ë¸Œë¼ìš°ì € localStorage(ê°„ì´ DB)</span>
      </div>

      <div class="tip">
        <b>ë¯¸ì„¸ì¡°ì • ì‚¬ìš©ë²•</b><br/>
        1) <span class="kbd">ë¯¸ì„¸ì¡°ì • ëª¨ë“œ ON</span> â†’ ì›/ë°•ìŠ¤ë¥¼ <b>ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸</b><br/>
        2) <span class="kbd">ìŠ¤ëƒ… ON</span>ì´ë©´ 5px ë‹¨ìœ„ë¡œ â€œì°©â€ ë¶™ì–´ì„œ ì •ë ¬ì´ ì‰¬ì›€(OFFë„ ê°€ëŠ¥)<br/>
        3) ëë‚˜ë©´ <span class="kbd">ì¢Œí‘œ ë‚´ë³´ë‚´ê¸°</span>ë¡œ ì¢Œí‘œë¥¼ ë³µì‚¬í•´ë‘ë©´ ì•ˆì „(ë°±ì—…)<br/>
        â€» ë“œë˜ê·¸ë¡œ ì›€ì§ì´ë©´ <b>ìë™ ì €ì¥</b>ë˜ë¯€ë¡œ ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€ë¨
      </div>

      <div style="margin-top:10px;">
        <div class="small"><b>Raw ë°ì´í„° ë¶™ì—¬ë„£ê¸°</b> (ì—‘ì…€ ë²”ìœ„ ë³µì‚¬ â†’ ì—¬ê¸° í´ë¦­ â†’ Ctrl+V)</div>
        <textarea id="raw" placeholder="TANK NO.  ì…ì¶œê³   ì¸¡ì •ëŸ‰  ë‹¨ìœ„  ì œí’ˆëª… ...&#10;L  9   -   71    ...  ê³ ê¸‰ì „ìš©ë¶„BULK"></textarea>
        <div class="small muted">
          - ì‹ ê·œ í¬ë§·: <b>TANK NO.</b>(Bì—´) / <b>ì¸¡ì •ëŸ‰</b>(Dì—´) / <b>ì œí’ˆëª…</b>(Fì—´)<br/>
          - ë„ë©´ì— ì—†ëŠ” íƒ±í¬ëŠ” ë¬´ì‹œ / Br1~Br12ëŠ” ì´ë¦„ë§Œ í‘œì‹œ / ë§ë¶„ ë¬´ì‹œ
        </div>
      </div>

      <div class="svgbox" style="margin-top:10px;">
        <svg id="board" width="1422" height="725" viewBox="0 0 1422 725" xmlns="http://www.w3.org/2000/svg" style="display:block; user-select:none;">
          <rect x="10" y="10" width="1402" height="705" fill="#fff" stroke="var(--line)" stroke-width="2"/>

          <!-- ìƒë‹¨ 3ì¤„ í…ìŠ¤íŠ¸ -->
          <text id="t_pack1" x="60" y="40" font-size="16" font-weight="800" fill="var(--red)">Packaging Bin : 45M/T x 24Q'ty = 1080M/T</text>
          <text id="t_pack2" x="240" y="62" font-size="16" font-weight="800" fill="var(--red)">80M/T x 6Q'ty = 450M/T</text>
          <text id="t_bulkTop" x="60" y="84" font-size="16" font-weight="800" fill="var(--blue)">Bulk Loding Bin : 80M/T x 6Q'ty = 420M/T</text>
          <line x1="40" y1="100" x2="520" y2="100" stroke="var(--line)" stroke-width="2"/>

          <!-- ê¸°ì¤€ ë°•ìŠ¤/ë¼ì¸ -->
          <rect x="40" y="100" width="480" height="420" fill="none" stroke="var(--line)" stroke-width="2"/>
          <path d="M40 100 L40 640 L95 640 L95 520 L40 520" fill="none" stroke="var(--line)" stroke-width="2"/>
          <text x="70" y="620" font-size="18" font-weight="800" transform="rotate(90 70 620)">OFFICE</text>

          <line x1="520" y1="10" x2="520" y2="520" stroke="var(--line)" stroke-width="2"/>
          <line x1="950" y1="10" x2="950" y2="520" stroke="var(--line)" stroke-width="2"/>
          <line x1="1050" y1="10" x2="1050" y2="520" stroke="var(--line)" stroke-width="2"/>

          <text x="610" y="170" font-size="34" fill="var(--gray)">(New)</text>
          <text x="780" y="170" font-size="40" fill="var(--gray)">Milling Area (Old)</text>

          <text x="680" y="360" font-size="16" font-weight="800" fill="var(--purple)">Semi-finished Bin : 25M/T x 6Q'ty</text>
          <text x="835" y="382" font-size="16" font-weight="800" fill="var(--purple)">= 150M/T</text>

          <text x="940" y="360" font-size="16" font-weight="800" fill="var(--gray)">Bran byproduct Bin : 30M/T x 8Q'ty = 240M/T</text>

          <text x="820" y="420" font-size="16" font-weight="900" fill="var(--green)">Premix Bin : 35M/T x 4Q'ty</text>
          <text x="885" y="442" font-size="16" font-weight="900" fill="var(--green)">= 140M/T</text>

          <text x="420" y="650" font-size="18" font-weight="900" fill="var(--blue)">Bulk Loding Bin : 40M/T x 12Q'ty + 80M/T x 8Q'ty = 1600M/T</text>

          <!-- ë“œë˜ê·¸ ì•ˆë‚´ í‘œì‹œ -->
          <g id="editOverlay" opacity="0">
            <rect x="18" y="18" width="400" height="34" fill="#111" opacity="0.72" rx="8"/>
            <text x="30" y="41" fill="#fff" font-size="13" font-weight="800">ë¯¸ì„¸ì¡°ì • ëª¨ë“œ ON : íƒ±í¬ë¥¼ ë“œë˜ê·¸í•´ì„œ ìœ„ì¹˜ ì¡°ì •</text>
          </g>

          <g id="tank_Bran"></g>
          <g id="rowBr"></g>
          <g id="stackBr"></g>
          <g id="tankGroup"></g>
        </svg>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin:0 0 8px;">
        <h1 style="margin:0;">íƒ±í¬ë³„ ìƒì„¸ (ì œí’ˆëª… í¬í•¨)</h1>
        <span class="pill"><b class="danger">85%â†‘</b> ê°•ì¡°</span>
      </div>
      <div class="small muted">
        - í—¤ë”: Tank / ì¬ê³ ëŸ‰(T) / ì œí’ˆëª…
      </div>
      <div style="height:612px; overflow:auto; border:1px solid #ddd; border-radius:10px; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th style="width:90px;">Tank</th>
              <th style="width:90px;">ì¬ê³ ëŸ‰(T)</th>
              <th>ì œí’ˆëª…</th>
            </tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* =========================
   ê¸°ë³¸ ì„¤ì •
========================= */
const HI_PCT = 85;
const LS_KEY = "tank_board_snapshots_v2";
const LS_LAYOUT = "tank_board_layout_v2";

function css(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
const COLORS = { red: css('--red'), blue: css('--blue'), purple: css('--purple'), green: css('--green'), gray: css('--gray'), line: css('--line'), zero: css('--zero'), hi: css('--hi') };

const svg = document.getElementById('board');
const g = document.getElementById('tankGroup');

let editMode = false;
let snapOn = true;
const SNAP = 5;

/* =========================
   ë„ë©´ íƒ±í¬ ì •ì˜(ì¢Œí‘œëŠ” "ì´ˆê¸°ê°’", ì´í›„ ë“œë˜ê·¸ë¡œ ì €ì¥ë¨)
========================= */
const R = 22, FS1 = 13, FS2 = 14, FS3 = 11;

function C(name, cx, cy, type, capT){ return {kind:"circle", name, cx, cy, type, capT}; }
function B(name, x, y, w, h, capT){ return {kind:"box", name, x, y, w, h, capT}; }

const DEFAULT_LAYOUT = {
  circles: [
    // Packaging + A/P
    C("A6",  70, 132, "red", 80), C("A5", 120, 132, "red", 80), C("P3-8",170,132,"red",45), C("P3-7",220,132,"red",45), C("P2-8",270,132,"red",45), C("P2-7",320,132,"red",45), C("P1-8",370,132,"red",45), C("P1-7",420,132,"red",45),
    C("A4",  70, 186, "red", 80), C("A3", 120, 186, "red", 80), C("P3-6",170,186,"red",45), C("P3-5",220,186,"red",45), C("P2-6",270,186,"red",45), C("P2-5",320,186,"red",45), C("P1-6",370,186,"red",45), C("P1-5",420,186,"red",45),
    C("A2",  70, 240, "red", 80), C("A1", 120, 240, "red", 80), C("P3-4",170,240,"red",45), C("P3-3",220,240,"red",45), C("P2-4",270,240,"red",45), C("P2-3",320,240,"red",45), C("P1-4",370,240,"red",45), C("P1-3",420,240,"red",45),
    C("P3-2",195,300,"red",45), C("P3-1",245,300,"red",45), C("P2-2",295,300,"red",45), C("P2-1",345,300,"red",45), C("P1-2",395,300,"red",45), C("P1-1",445,300,"red",45),

    // T
    C("T6",210,355,"blue",80), C("T5",260,355,"blue",80), C("T4",310,355,"blue",80), C("T3",360,355,"blue",80), C("T2",410,355,"blue",80), C("T1",460,355,"blue",80),

    // L1~L6
    C("L1",650,390,"purple",25), C("L2",705,390,"purple",25), C("L3",760,390,"purple",25), C("L4",815,390,"purple",25), C("L5",870,390,"purple",25), C("L6",925,390,"purple",25),

    // B1~B4 (green)
    C("B4",915,350,"green",35), C("B1",960,350,"green",35), C("B3",915,395,"green",35), C("B2",960,395,"green",35),

    // L7~L26
    C("L15",720,500,"blue",60), C("L16",770,500,"blue",60), C("L17",820,500,"blue",60), C("L18",870,500,"blue",60), C("L19",920,500,"blue",40), C("L20",970,500,"blue",40), C("L8",1020,500,"blue",80), C("L7",1070,500,"blue",80),
    C("L21",720,560,"blue",60), C("L22",770,560,"blue",60), C("L23",820,560,"blue",60), C("L24",870,560,"blue",60), C("L25",920,560,"blue",40), C("L26",970,560,"blue",40), C("L10",1050,560,"blue",80), C("L9",1100,560,"blue",80),
    C("L12",1035,610,"blue",80), C("L11",1085,610,"blue",80), C("L14",1035,660,"blue",80), C("L13",1085,660,"blue",80),
  ],
  bran: {name:"Bran", cx:1360, cy:80, capT:400},
  brRow: [
    B("Br12",1020,390,50,45,30), B("Br11",1070,390,50,45,30), B("Br10",1120,390,50,45,30), B("Br9",1170,390,50,45,30),
    B("Br8",1220,390,50,45,40),  B("Br7",1270,390,50,45,40),  B("Br6",1320,390,50,45,40),  B("Br5",1370,390,50,45,40),
  ],
  brStack: [
    B("Br4",1320,435,90,62,100), B("Br3",1320,497,90,62,100), B("Br2",1320,559,90,62,100), B("Br1",1320,621,90,62,100),
  ]
};

function loadLayout(){
  try{
    const v = JSON.parse(localStorage.getItem(LS_LAYOUT) || "null");
    if(!v) return structuredClone(DEFAULT_LAYOUT);
    return v;
  }catch(e){
    return structuredClone(DEFAULT_LAYOUT);
  }
}
function saveLayout(layout){
  localStorage.setItem(LS_LAYOUT, JSON.stringify(layout));
}
let LAYOUT = loadLayout();

/* =========================
   Raw íŒŒì„œ (ì‹ ê·œ/êµ¬í˜•)
========================= */
function normalizeTankName(s){
  if(!s) return "";
  s = String(s).trim().replace(/\s+/g,' ');
  if(/^P\d-\d$/i.test(s)) return s.toUpperCase();
  s = s.replace(/^([A-Za-z])\s+(\d+)$/,'$1$2');
  return s.toUpperCase();
}
function parseNumberT(s){
  if(s==null) return null;
  let t = String(s).trim();
  if(!t) return null;
  t = t.replace(/,/g,'').replace(/\.$/,'');
  const v = Number(t);
  return Number.isFinite(v) ? v : null;
}
function parseRaw(raw){
  const text = (raw||"").trim();
  if(!text) return [];
  const lines = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const header = lines[0] || "";
  const isNew = /TANK\s*NO\.?/i.test(header);
  const isOld = /SILO\/TANKë²ˆí˜¸/i.test(header) || /ì¬ê³ êµ¬ë¶„/i.test(header);
  const out = [];
  for(let i=1;i<lines.length;i++){
    const line = lines[i];
    const parts = line.split(/\t+/).length>1 ? line.split(/\t+/) : line.split(/\s{2,}/);
    if(parts.length < 2) continue;

    if(isNew){
      const tank = normalizeTankName(parts[0]);
      if(!tank) continue;
      // ë§ë¶„ ë¬´ì‹œ(ìš”ì²­)
      if(tank === "ETC_3" || tank === "ë§ë¶„") continue;
      const qtyT = parseNumberT(parts[2]) ?? 0;
      const product = (parts[4] ?? "").trim();
      out.push({tank, qtyT, product});
    }else if(isOld){
      const tank = normalizeTankName(parts[1]);
      const product = (parts[3] ?? "").trim();
      const qtyKG = parseNumberT(parts[5]) ?? 0;
      out.push({tank, qtyT: qtyKG/1000, product});
    }else{
      const tank = normalizeTankName(parts[0]);
      const qtyT = parseNumberT(parts[1]) ?? 0;
      const product = parts.slice(2).join(' ').trim();
      out.push({tank, qtyT, product});
    }
  }
  return out;
}

/* =========================
   ë‚ ì§œë³„ ì €ì¥(localStorage)
========================= */
function loadDB(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }catch(e){ return {}; } }
function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }
function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

/* =========================
   SVG ë Œë”
========================= */
function el(tag, attrs={}, text=null){
  const n = document.createElementNS('http://www.w3.org/2000/svg', tag);
  for(const [k,v] of Object.entries(attrs)) n.setAttribute(k, v);
  if(text!=null) n.textContent = text;
  return n;
}
function clearSVG(node){ while(node.firstChild) node.removeChild(node.firstChild); }
function pct(q, cap){ if(!cap||cap<=0) return 0; return Math.round((q/cap)*100); }
function fmt(v){ if(!Number.isFinite(v)) return "-"; return (Math.round(v*100)/100).toString(); }

function renderBran(qtyT){
  const host = document.getElementById('tank_Bran');
  clearSVG(host);
  const b = LAYOUT.bran;
  const p = pct(qtyT, b.capT);
  const fill = qtyT===0 ? COLORS.zero : (p>=HI_PCT ? COLORS.hi : "#fff");
  const grp = el('g', {"data-id":"BRAN","data-kind":"bran"});
  grp.appendChild(el('circle',{cx:b.cx,cy:b.cy,r:32,fill,stroke:COLORS.line,'stroke-width':2}));
  grp.appendChild(el('text',{x:b.cx,y:b.cy-6,'text-anchor':'middle','font-size':16,'font-weight':900,fill:'#111'},"Bran"));
  grp.appendChild(el('text',{x:b.cx,y:b.cy+14,'text-anchor':'middle','font-size':18,'font-weight':900,fill:'#111'},`${fmt(qtyT)}t`));
  grp.appendChild(el('text',{x:b.cx,y:b.cy+32,'text-anchor':'middle','font-size':12,'font-weight':800,fill:'#444'},`(${p}%)`));
  host.appendChild(grp);
  makeDraggable(grp, () => ({x: b.cx, y: b.cy}), (nx,ny) => { b.cx=nx; b.cy=ny; saveLayout(LAYOUT); });
}

function renderBrBoxes(){
  const rowHost = document.getElementById('rowBr');
  const stHost  = document.getElementById('stackBr');
  clearSVG(rowHost); clearSVG(stHost);

  for(const b of LAYOUT.brRow){
    const grp = el('g', {"data-id":b.name,"data-kind":"boxRow"});
    grp.appendChild(el('rect',{x:b.x,y:b.y,width:b.w,height:b.h,fill:"#fff",stroke:COLORS.line,'stroke-width':2}));
    grp.appendChild(el('text',{x:b.x+b.w/2,y:b.y+24,'text-anchor':'middle','font-size':13,'font-weight':900,fill:'#111'}, b.name));
    grp.appendChild(el('text',{x:b.x+b.w/2,y:b.y+40,'text-anchor':'middle','font-size':11,'font-weight':800,fill:'#111'}, `${b.capT}t`));
    rowHost.appendChild(grp);

    makeDraggable(grp,
      () => ({x: b.x, y: b.y}),
      (nx,ny) => { b.x=nx; b.y=ny; saveLayout(LAYOUT); }
    );
  }

  for(const b of LAYOUT.brStack){
    const grp = el('g', {"data-id":b.name,"data-kind":"boxStack"});
    grp.appendChild(el('rect',{x:b.x,y:b.y,width:b.w,height:b.h,fill:"#fff",stroke:COLORS.line,'stroke-width':2}));
    grp.appendChild(el('text',{x:b.x+b.w/2,y:b.y+26,'text-anchor':'middle','font-size':14,'font-weight':900,fill:'#111'}, b.name));
    grp.appendChild(el('text',{x:b.x+b.w/2,y:b.y+46,'text-anchor':'middle','font-size':12,'font-weight':800,fill:'#111'}, `${b.capT}t`));
    stHost.appendChild(grp);

    makeDraggable(grp,
      () => ({x: b.x, y: b.y}),
      (nx,ny) => { b.x=nx; b.y=ny; saveLayout(LAYOUT); }
    );
  }
}

function circleTankNode(tank, qtyT){
  const p = pct(qtyT, tank.capT);
  const fill = qtyT===0 ? COLORS.zero : (p>=HI_PCT ? COLORS.hi : "#fff");
  const grp = el('g', {"data-id":tank.name, "data-kind":"circle"});
  grp.appendChild(el('circle',{cx:tank.cx,cy:tank.cy,r:R,fill,stroke:(COLORS[tank.type]||COLORS.gray),'stroke-width':2}));
  grp.appendChild(el('text',{x:tank.cx,y:tank.cy-6,'text-anchor':'middle','font-size':FS1,'font-weight':900,fill:(COLORS[tank.type]||COLORS.gray)}, tank.name));
  grp.appendChild(el('text',{x:tank.cx,y:tank.cy+11,'text-anchor':'middle','font-size':FS2,'font-weight':900,fill:(COLORS[tank.type]||COLORS.gray)}, `${fmt(qtyT)}t`));
  grp.appendChild(el('text',{x:tank.cx,y:tank.cy+25,'text-anchor':'middle','font-size':FS3,'font-weight':800,fill:'#444'}, `(${p}%)`));
  return grp;
}

function renderAll(rows){
  // ë„ë©´ì— ìˆëŠ” íƒ±í¬ë§Œ ë°˜ì˜(ìš”ì²­)
  const allowed = new Set(LAYOUT.circles.map(t=>t.name.toUpperCase()));
  const data = new Map();
  for(const r of rows){
    const k = normalizeTankName(r.tank);
    if(!k) continue;
    // ë§ë¶„ ë¬´ì‹œ
    if(k==="ETC_3") continue;

    // Branì€ ETC_2 ë˜ëŠ” BRANìœ¼ë¡œ ë“¤ì–´ì™€ë„ ì²˜ë¦¬
    if(k==="ETC_2" || k==="BRAN"){
      data.set("BRAN",{qtyT:Number.isFinite(r.qtyT)?r.qtyT:0, product:r.product||""});
      continue;
    }

    if(!allowed.has(k)) continue;
    data.set(k,{qtyT:Number.isFinite(r.qtyT)?r.qtyT:0, product:r.product||""});
  }

  // íƒ±í¬
  clearSVG(g);
  for(const t of LAYOUT.circles){
    const d = data.get(t.name.toUpperCase()) || {qtyT:0, product:""};
    const node = circleTankNode(t, d.qtyT);
    g.appendChild(node);

    makeDraggable(node,
      () => ({x: t.cx, y: t.cy}),
      (nx,ny) => { t.cx=nx; t.cy=ny; saveLayout(LAYOUT); }
    );
  }

  // Bran
  const branQty = (data.get("BRAN")?.qtyT) ?? 0;
  renderBran(branQty);

  // Br boxes
  renderBrBoxes();

  // ì˜¤ë¥¸ìª½ í‘œ
  const tbody = document.getElementById('tbl');
  tbody.innerHTML = "";
  // í‘œëŠ” circles ìˆœì„œëŒ€ë¡œ + Bran
  const order = [
    "A6","A5","P3-8","P3-7","P2-8","P2-7","P1-8","P1-7",
    "A4","A3","P3-6","P3-5","P2-6","P2-5","P1-6","P1-5",
    "A2","A1","P3-4","P3-3","P2-4","P2-3","P1-4","P1-3",
    "P3-2","P3-1","P2-2","P2-1","P1-2","P1-1",
    "T6","T5","T4","T3","T2","T1",
    "L1","L2","L3","L4","L5","L6",
    "B4","B1","B3","B2",
    "L15","L16","L17","L18","L19","L20","L8","L7",
    "L21","L22","L23","L24","L25","L26","L10","L9",
    "L12","L11","L14","L13",
    "BRAN"
  ];

  for(const name of order){
    if(name==="BRAN"){
      addRow("Bran", branQty, "(Bran)");
      continue;
    }
    const d = data.get(name) || {qtyT:0, product:""};
    addRow(name, d.qtyT, d.product);
  }

  function addRow(tank, qtyT, product){
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=tank; td1.className="mono";
    const td2=document.createElement('td'); td2.textContent=fmt(qtyT); td2.className="mono";
    const td3=document.createElement('td'); td3.textContent=product||"";
    tr.append(td1,td2,td3);
    tbody.appendChild(tr);
  }
}

/* =========================
   âœ… ë“œë˜ê·¸(ë¯¸ì„¸ì¡°ì •) êµ¬í˜„
   - editModeì¼ ë•Œë§Œ ë™ì‘
   - snapOnì´ë©´ 5px ìŠ¤ëƒ…
========================= */
let drag = null;

function svgPoint(evt){
  const pt = svg.createSVGPoint();
  pt.x = evt.clientX;
  pt.y = evt.clientY;
  return pt.matrixTransform(svg.getScreenCTM().inverse());
}

function snap(v){ return snapOn ? Math.round(v / SNAP) * SNAP : v; }

function makeDraggable(node, getPos, setPos){
  node.style.cursor = "default";
  node.addEventListener('mousedown', (e)=>{
    if(!editMode) return;
    e.preventDefault();
    e.stopPropagation();
    const p = svgPoint(e);
    const cur = getPos();
    drag = { node, getPos, setPos, startMouse:p, startPos:{...cur} };
    node.style.cursor = "grabbing";
  });
}

window.addEventListener('mousemove', (e)=>{
  if(!drag) return;
  const p = svgPoint(e);
  const dx = p.x - drag.startMouse.x;
  const dy = p.y - drag.startMouse.y;
  const nx = snap(drag.startPos.x + dx);
  const ny = snap(drag.startPos.y + dy);
  drag.setPos(nx,ny);
  // ì‹¤ì‹œê°„ ë°˜ì˜ ìœ„í•´ ë‹¤ì‹œ ë Œë”(ì¢Œí‘œë§Œ ë°”ë€Œë‹ˆ ë¹ ë¦„)
  // raw ë°ì´í„°ëŠ” ìœ ì§€, ë§ˆì§€ë§‰ ë Œë” ê²°ê³¼ë¥¼ ì¬ì‚¬ìš©í•˜ê¸° ìœ„í•´ globalRows ì‚¬ìš©
  renderAll(window.__lastRows || []);
});

window.addEventListener('mouseup', ()=>{
  if(!drag) return;
  drag.node.style.cursor = "grab";
  drag = null;
});

/* =========================
   ë²„íŠ¼/ë™ì‘
========================= */
const rawEl = document.getElementById('raw');
const dateEl = document.getElementById('datePick');
dateEl.value = todayISO();

document.getElementById('btnApply').addEventListener('click', ()=>{
  const rows = parseRaw(rawEl.value);
  window.__lastRows = rows;
  renderAll(rows);
});

document.getElementById('btnSave').addEventListener('click', ()=>{
  const d = dateEl.value || todayISO();
  const db = loadDB();
  db[d] = rawEl.value || "";
  saveDB(db);
  alert(`ì €ì¥ ì™„ë£Œ: ${d}`);
});

document.getElementById('btnLoad').addEventListener('click', ()=>{
  const d = dateEl.value || todayISO();
  const db = loadDB();
  const v = db[d];
  if(!v){ alert(`ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤: ${d}`); return; }
  rawEl.value = v;
  const rows = parseRaw(v);
  window.__lastRows = rows;
  renderAll(rows);
});

document.getElementById('btnClear').addEventListener('click', ()=>{
  rawEl.value = "";
  window.__lastRows = [];
  renderAll([]);
});

document.getElementById('btnEdit').addEventListener('click', ()=>{
  editMode = !editMode;
  document.getElementById('btnEdit').textContent = `ğŸ› ï¸ ë¯¸ì„¸ì¡°ì • ëª¨ë“œ: ${editMode ? "ON" : "OFF"}`;
  document.getElementById('editOverlay').setAttribute('opacity', editMode ? "1" : "0");
});

document.getElementById('btnSnap').addEventListener('click', ()=>{
  snapOn = !snapOn;
  document.getElementById('btnSnap').textContent = `ìŠ¤ëƒ…: ${snapOn ? "ON" : "OFF"}`;
});

document.getElementById('btnExport').addEventListener('click', async ()=>{
  const payload = JSON.stringify(LAYOUT, null, 2);
  try{
    await navigator.clipboard.writeText(payload);
    alert("ì¢Œí‘œ JSONì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. (ë©”ëª¨ì¥ì— ë¶™ì—¬ë„£ì–´ ë°±ì—… ê°€ëŠ¥)");
  }catch(e){
    // fallback
    prompt("ë³µì‚¬ê°€ ë§‰í˜”ìŠµë‹ˆë‹¤. ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì„¸ìš”:", payload);
  }
});

document.getElementById('btnResetLayout').addEventListener('click', ()=>{
  if(!confirm("ì •ë§ ì¢Œí‘œë¥¼ ì´ˆê¸°ê°’ìœ¼ë¡œ ë˜ëŒë¦´ê¹Œìš”?")) return;
  LAYOUT = structuredClone(DEFAULT_LAYOUT);
  saveLayout(LAYOUT);
  renderAll(window.__lastRows || []);
});

function loadDB(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }catch(e){ return {}; } }
function saveDB(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

// ì²« ë Œë”
window.__lastRows = [];
renderAll([]);
</script>
</body>
</html>
